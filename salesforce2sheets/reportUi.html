<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
<!-- <link rel=stylesheet href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css">  -->

<style>
    #throbber {
      left: 50%;
      height: 48px;
      margin-left: -14px;
      position: absolute;
      top: 15%;
      width: 48px;
    }
    .left-margin {
      margin-left: 10px;
    }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

<script>
    //add reference to the server side variables and language objects to the client so can use within the javascript
    var CONFIG_OBJ = <?!= JSON.stringify(configObj) ?>;
    $(document).ready(function() {
      $('#throbber').hide();
       //$('#reports-group').hide();
       
      <?if (!isOAuthed()){?>
        $('#authsetup').show(); 
        $('#configForm').hide();
      <?} else {?>
        $('#authsetup').hide();
        $('#configForm').show();
      <?}?>
      
      $('#authlink').click(function(){
        $('#authsetup').hide();
        $('#throbber').show();
        checkForOAuthKey();
      });
      
      $('#load').click(function(){
        $('#configForm').hide();
        $('#throbber').show();
        google.script.run.withSuccessHandler(submissionSucceeded).withFailureHandler(handleError).runReport($('#reports').val(),$("#reports option:selected").text());
      });
      
      <?if (configObj.invalidRefresh != "true") {?> 
        $('#invalidRefresh').hide();
      <?} else {?>
        $('#invalidRefresh').text(<?=configObj.message?>);
      <?}?>    

    });

    function handleError(e){
     alert(e);
     submissionSucceeded();
    }

    function submissionSucceeded(){
      $('#configForm').show();
      $('#throbber').hide();
      google.script.host.close();
    }

    var timeoutId = null;
    function checkForOAuthKey() {
      //console.log(new Date() + 'checking for OAuth Key');
      google.script.run.withSuccessHandler(gotOAuthCheckBack).isOAuthed();
      timeoutId = window.setTimeout(checkForOAuthKey, 3000);
    }

    function gotOAuthCheckBack(e){
      //console.log(new Date() + 'Got back ' + e + ' for oauth check');
      if(e){
        //console.log(new Date() + 'Clearing timeout');
        window.clearTimeout(timeoutId);
        timeoutId = null;
        $('#throbber').hide();
        $('#configForm').show();
      }
    }
    
    function getReportList(selection) { 
       $('#reports-group').css('visibility', 'hidden');
       $('#throbber').show();
       google.script.run
          .withSuccessHandler(
              function(response) {

                var optionsArr = response.reportArr;
                var optionsObj = response.reportObj;
        
                var optionsAsString = "";   
                var len = optionsArr.length;
                for (var i=len;i--;) {
                  optionsAsString += "<option value='" + optionsObj[optionsArr[i]] + "'>" + optionsArr[i] + "</option>";
                }
                
                $("select[name='reports']").find('option').remove().end().append($(optionsAsString))
                $('#reports-group').css('visibility', 'visible');                
                $('#invalidRefresh').hide();
                $('#throbber').hide();
              })
          ._getReportList(selection); // invoke the .gs script parent function
    }
    
    function enableButton() { // doesn't do anything since disabled not working...
       $('load').removeClass('btn-disabled');
       $("load").prop('disabled', false); //disabled property is not taking effect
    }
    
    function cancel() {
     google.script.host.close();
    }
    
</script>


<img id=throbber src="//ssl.gstatic.com/music/ap/cec6433ac17a57a5ad3264da7b23e565/Spinner_48.gif"
alt="Loading...">

<legend class="left-margin"><img src='https://www.sfdcstatic.com/common/assets/img/logo-company.png' alt="Salesforce logo"/></legend>
 


<div id=authsetup>
    <p class="error left-margin">
        Please click on the link below to authorize application to Salesforce.com. This page will automatically refresh when you return.
        <br>
        <br>
        <center>
        <a href='<?=getURLForAuthorization()?>' id=authlink class="action" ><img src="https://googledrive.com/host/0B7eOaxjf0g3YTVR0MVNlak9RX3c/button_authorize_app.png" alt="Authorize App"></a></center>
    </p>
</div>


<form id=configForm>
    <fieldset>
      
      <br>
      <div id=invalidRefresh class="error left-margin" ></div>  <!-- text is inserted by jquery -->
      
      <br>
      <div>
         <input type="radio" name="reportType" id="radio1" value="recentReports" onclick=getReportList(1)>
         <label for="radio1">Recent Reports</label>  <!-- don't check by default since don't want to get recent reports if user wants all reports -->
      </div>
      <div>
         <input type="radio" name="reportType" id="radio2" value="allReports" onclick=getReportList(2)>
         <label for="radio2">All Reports</label>
      </div>
      
      <br>
      <div id='reports-group' class="block form-group" style="visibility: hidden">
         <label for="reports">Reports</label>
              <select id='reports' name='reports' class=input-large onclick=enableButton()><?!= reportArr.map(function(name) {
                return '<option' + (name == reportSelected ? ' selected="selected"' : '') + '>' + name;
              }).join(''); ?></select> 
      </div>
     <br><br><br>
        <div class="form-actions"> 
            <button id=load name=load class="action" type=submit>Load Detail</button>   
            <button id=cancel name=cancel type=button onclick=cancel()>Cancel</button>   
        </div>
    </fieldset>
</form>
